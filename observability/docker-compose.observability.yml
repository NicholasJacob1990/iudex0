version: "3.9"

services:
  grafana:
    image: grafana/grafana:11.2.0
    ports:
      - "3000:3000"
    environment:
      GF_SECURITY_ADMIN_PASSWORD: "admin"
      GRAFANA_DB_HOST: "host.docker.internal"
      GRAFANA_DB_PORT: "5432"
      GRAFANA_DB_NAME: "app_db"
      GRAFANA_DB_USER: "app_user"
      GRAFANA_DB_PASSWORD: "app_pass"
    volumes:
      - ./grafana/provisioning:/etc/grafana/provisioning
      - ./grafana:/var/lib/grafana/dashboards

  metabase-db:
    image: postgres:16
    environment:
      POSTGRES_DB: "metabase"
      POSTGRES_USER: "metabase"
      POSTGRES_PASSWORD: "metabase"
    ports:
      - "5433:5432"
    volumes:
      - metabase_db:/var/lib/postgresql/data

  metabase:
    image: metabase/metabase:0.50.21
    ports:
      - "3001:3000"
    environment:
      MB_DB_TYPE: "postgres"
      MB_DB_DBNAME: "metabase"
      MB_DB_PORT: "5432"
      MB_DB_USER: "metabase"
      MB_DB_PASS: "metabase"
      MB_DB_HOST: "metabase-db"
    depends_on:
      - metabase-db

  rag-eval-cron:
    build:
      context: ..
      dockerfile: observability/rag_eval_cron.Dockerfile
    env_file:
      - ../.env
    environment:
      RAG_EVAL_CRON: "0 2 * * *"
      RAG_EVAL_DATASET: "/app/evals/sample_eval.jsonl"
      RAG_EVAL_OUT: "/app/evals/eval_results.json"
      RAG_EVAL_PERSIST_DB: "true"
    volumes:
      - ../evals:/app/evals

volumes:
  metabase_db:
