# =============================================================================
# IUDEX API - Production Environment Template
# =============================================================================
# Use this file as a reference for production deploys.
# Do not commit real secrets.

# =============================================================================
# SERVER
# =============================================================================
HOST=0.0.0.0
PORT=8000
ENVIRONMENT=production
DEBUG=false
LOG_LEVEL=INFO

# =============================================================================
# DATABASE (PostgreSQL recommended)
# =============================================================================
DATABASE_URL=postgresql+asyncpg://<user>:<password>@<host>:5432/<database>
DATABASE_POOL_SIZE=20
DATABASE_MAX_OVERFLOW=40

# =============================================================================
# SECURITY
# =============================================================================
SECRET_KEY=<random-32-bytes-or-more>
JWT_ALGORITHM=HS256
JWT_ACCESS_TOKEN_EXPIRE_MINUTES=30
JWT_REFRESH_TOKEN_EXPIRE_DAYS=7

# =============================================================================
# CORS
# =============================================================================
CORS_ORIGINS=https://<your-web-domain>

# =============================================================================
# AI PROVIDERS
# =============================================================================
OPENAI_API_KEY=<secret>
ANTHROPIC_API_KEY=<secret>
GOOGLE_API_KEY=<secret>
VOYAGE_API_KEY=<secret>
ISAACUS_API_KEY=<secret>

# =============================================================================
# TRANSCRIPTION / FORMATTING RESILIENCE (recommended for production)
# =============================================================================
# Mantém fallback para RAW se a IA de formatação ficar indisponível.
IUDEX_ALLOW_LLM_FALLBACK_RAW=1

# Timeout de inicialização do motor de formatação.
IUDEX_VOMO_INIT_TIMEOUT_SECONDS=240

# Timeout adaptativo global:
# max(IUDEX_FORMAT_TIMEOUT_SECONDS, estimated_chunks * IUDEX_FORMAT_TIMEOUT_PER_CHUNK_SECONDS)
IUDEX_FORMAT_TIMEOUT_SECONDS=900
IUDEX_FORMAT_TIMEOUT_PER_CHUNK_SECONDS=120
IUDEX_FORMAT_TIMEOUT_CHARS_PER_CHUNK=15000

# Teto de segurança para não deixar jobs "eternos" em produção.
IUDEX_FORMAT_TIMEOUT_MAX_SECONDS=2700

# Timeout por segmento:
# - 0 = usa modo automático (recomendado)
# - >0 = força valor fixo por segmento
IUDEX_FORMAT_SEGMENT_TIMEOUT_SECONDS=0
IUDEX_FORMAT_SEGMENT_TIMEOUT_AUTO_SECONDS=120

# Retry de modelo em timeout/quota:
# se o modelo principal for preview (ex.: gemini-3-*-preview), tenta este estável.
IUDEX_FORMAT_RETRY_STABLE_MODEL=gemini-2.0-flash

# Processamento sequencial prioriza estabilidade/fidelidade.
IUDEX_PARALLEL_CHUNKS=1

# =============================================================================
# GRAPHRAG (Neo4j Aura Enterprise)
# =============================================================================
RAG_GRAPH_BACKEND=neo4j
NEO4J_URI=neo4j+s://<instance-id>.databases.neo4j.io
NEO4J_USERNAME=neo4j
NEO4J_USER=neo4j
NEO4J_PASSWORD=<secret>
NEO4J_DATABASE=neo4j
AURA_INSTANCEID=<instance-id>
AURA_INSTANCENAME=<instance-name>

# Optional graph knobs
RAG_GRAPH_HYBRID_MODE=true
RAG_GRAPH_HYBRID_AUTO_SCHEMA=true
RAG_GRAPH_HYBRID_MIGRATE_ON_STARTUP=false
NEO4J_MAX_HOPS=2
NEO4J_MAX_CHUNKS=50

# neo4j-graphrag KG Builder (Graph extraction)
# KG_BUILDER_GRAPHRAG_SEGMENT_SIZE=4000
# KG_BUILDER_GRAPHRAG_SEGMENT_OVERLAP=600  # default: ~15% do segment_size (legal)
# KG_BUILDER_GRAPHRAG_COST_PER_1M_INPUT_TOKENS_USD=  # optional (observability only)
#
# Embeddings provider for KG Builder (default: openai)
# KG_BUILDER_EMBEDDING_PROVIDER=openai  # openai|vertexai|none
# KG_BUILDER_EMBEDDING_MODEL=text-embedding-3-small

# =============================================================================
# RAG INFRASTRUCTURE
# =============================================================================
OPENSEARCH_URL=https://<opensearch-host>:9200
OPENSEARCH_USER=<opensearch-user>
OPENSEARCH_PASS=<secret>
OPENSEARCH_VERIFY_CERTS=true
QDRANT_URL=https://<qdrant-host>:6333
QDRANT_API_KEY=<secret>

# =============================================================================
# RAG FEATURES
# =============================================================================
RAG_USE_NEW_PIPELINE=true
RAG_ENABLE_CRAG=true
RAG_ENABLE_HYDE=true
RAG_ENABLE_MULTIQUERY=true
RAG_ENABLE_RERANK=true
RAG_ENABLE_COMPRESSION=true
RAG_ENABLE_GRAPH_ENRICH=true
RAG_ENABLE_TRACING=true

# =============================================================================
# OBSERVABILITY / OPERATIONS (recommended)
# =============================================================================
SENTRY_DSN=<secret>
# REDIS_URL=redis://<redis-host>:6379/0

# =============================================================================
# Production checklist
# =============================================================================
# 1) Secrets from secret manager (not .env in repository).
# 2) NEO4J_URI must be neo4j+s://... (never localhost).
# 3) Network restrictions enabled for AuraDB.
# 4) Backup/restore tested with defined RPO/RTO.
# 5) Monitoring alerts for Neo4j/API latency and error rates.

# =============================================================================
# Graph Writes (Safe, 2-phase) + Tool Approval Tokens (Cryptographically Binding)
# =============================================================================
# `link_entities` requires preflight + confirm=true + token.
LINK_ENTITIES_REQUIRE_CONFIRM=true
LINK_ENTITIES_PREFLIGHT_TTL_SECONDS=900
LINK_ENTITIES_TOKEN_SECRET=your-random-secret-here

# Tool approvals (SSE resume) require server-issued approval_token.
TOOL_APPROVAL_REQUIRE_TOKEN=true
TOOL_APPROVAL_TTL_SECONDS=900
TOOL_APPROVAL_TOKEN_SECRET=your-random-secret-here

# =============================================================================
# Text2Cypher (Graph page /t2c)
# =============================================================================
TEXT2CYPHER_ENABLED=true
TEXT2CYPHER_LLM_PROVIDER=openai
TEXT2CYPHER_MODEL=gpt-4o-mini
