# =============================================================================
# IUDEX API - Environment Variables
# =============================================================================
# Copy this file to .env and fill in your actual values

# =============================================================================
# SERVER CONFIGURATION
# =============================================================================
HOST=0.0.0.0
PORT=8000
ENVIRONMENT=development
DEBUG=true

# =============================================================================
# DATABASE
# =============================================================================
# SQLite (Development)
DATABASE_URL=sqlite+aiosqlite:///./iudex.db

# PostgreSQL (Production - Recommended)
# DATABASE_URL=postgresql+asyncpg://user:password@localhost:5432/iudex

DATABASE_POOL_SIZE=10
DATABASE_MAX_OVERFLOW=20

# =============================================================================
# SECURITY
# =============================================================================
# Generate with: openssl rand -hex 32
SECRET_KEY=your-secret-key-here-replace-with-random-string

# JWT Configuration
JWT_ALGORITHM=HS256
JWT_ACCESS_TOKEN_EXPIRE_MINUTES=30
JWT_REFRESH_TOKEN_EXPIRE_DAYS=7

# =============================================================================
# CORS
# =============================================================================
CORS_ORIGINS=http://localhost:3000,http://localhost:3001

# =============================================================================
# STORAGE
# =============================================================================
LOCAL_STORAGE_PATH=storage

# =============================================================================
# AI PROVIDERS
# =============================================================================

# OpenAI
OPENAI_API_KEY=your-openai-api-key
OPENAI_MODEL=gpt-4-turbo-preview

# Anthropic (Claude)
ANTHROPIC_API_KEY=your-anthropic-api-key
ANTHROPIC_MODEL=claude-3-opus-20240229

# Google (Gemini)
GOOGLE_API_KEY=your-google-api-key
GEMINI_MODEL=gemini-pro

# Voyage AI (Embeddings juridicos especializados)
# +6% vs OpenAI em benchmarks juridicos, 2x mais barato, 16K tokens
# Modelos: voyage-law-2 (juridico), voyage-3-large (geral), voyage-3-lite (rapido)
VOYAGE_API_KEY=
VOYAGE_DEFAULT_MODEL=voyage-law-2
VOYAGE_FALLBACK_MODEL=voyage-3-large

# Kanon 2 Embedder (Isaacus) — Direito internacional (US/UK/EU)
# #1 no MLEB benchmark, supera OpenAI em 9% em tarefas jurídicas
# Docs: https://docs.isaacus.com
ISAACUS_API_KEY=
# KANON_DIMENSIONS=1024  # Matryoshka: 1792, 1024, 768, 512, 256

# JurisBERT (local) — Direito brasileiro
# Self-hosted via sentence-transformers, sem API externa
JURISBERT_MODEL_NAME=juridics/bertlaw-base-portuguese-sts-scale
JURISBERT_DEVICE=cpu  # cpu, cuda, mps, ou auto

# Smart Routing — Threshold para pular RAG (documento pequeno → LLM direto)
# SMART_SKIP_RAG_CHARS=400000

# Deep Research (fontes obrigatórias)
DEEP_RESEARCH_REQUIRE_SOURCES=1

# =============================================================================
# MODEL REGISTRY OVERRIDES (OPTIONAL)
# =============================================================================
# The app uses canonical ids (ex: gpt-5.2, claude-4.5-sonnet) and maps them
# to provider model ids. Override these if you want to pin exact provider names.
GPT_5_2_API_MODEL=gpt-4o
GPT_5_API_MODEL=gpt-4o
GPT_5_MINI_API_MODEL=gpt-4o-mini
CLAUDE_4_5_SONNET_API_MODEL=claude-sonnet-4-5-20250929
CLAUDE_4_5_HAIKU_API_MODEL=claude-3-5-haiku-20241022
CLAUDE_4_5_OPUS_API_MODEL=claude-opus-4-5-20251101

# =============================================================================
# SEARCH SERVICES
# =============================================================================

# Google Custom Search (for Web Search)
GOOGLE_SEARCH_API_KEY=your-google-search-api-key
GOOGLE_SEARCH_CX=your-custom-search-engine-id

# Bing Search API
BING_SEARCH_API_KEY=your-bing-subscription-key

# Perplexity Search API (Primary)
PERPLEXITY_API_KEY=your-perplexity-api-key

# Serper API (Fallback)
SERPER_API_KEY=your-serper-api-key

# =============================================================================
# CNJ / DJEN (DataJud + Comunica)
# =============================================================================

CNJ_API_URL=https://api-publica.datajud.cnj.jus.br
CNJ_API_KEY=your-datajud-api-key
DJEN_API_URL=https://comunicaapi.pje.jus.br/api/v1
DJEN_API_KEY=

# =============================================================================
# TEXT-TO-SPEECH (Podcast Generation)
# =============================================================================

# Google Cloud TTS (Recommended)
GOOGLE_APPLICATION_CREDENTIALS=/path/to/google-credentials.json

# AWS Polly
AWS_ACCESS_KEY_ID=your-aws-access-key
AWS_SECRET_ACCESS_KEY=your-aws-secret-key
AWS_REGION=us-east-1

# ElevenLabs (Optional)
ELEVENLABS_API_KEY=your-elevenlabs-api-key

# =============================================================================
# TRANSCRIPTION (Audio/Video)
# =============================================================================

# OpenAI Whisper API (Recommended for production)
# Uses OPENAI_API_KEY above

# Local Whisper (Alternative - no API key needed but slower)
# Automatically used if OPENAI_API_KEY is not set

# RunPod Serverless (WhisperX)
RUNPOD_API_KEY=
RUNPOD_ENDPOINT_ID=                    # Primário: endpoint oficial faster-whisper
RUNPOD_FALLBACK_ENDPOINT_ID=           # Fallback: endpoint custom (usado se o primário falhar)
RUNPOD_DIARIZE_ENDPOINT_ID=            # Diarização: endpoint pyannote (opcional)
RUNPOD_MAX_CONCURRENCY=5

# Base URL da API backend (local default)
IUDEX_BASE_URL=http://localhost:8000

# URL pública acessível pelo RunPod para baixar o áudio.
# Em desenvolvimento local, use um túnel (ex.: cloudflared/ngrok).
# Exemplo: https://abc123.trycloudflare.com
IUDEX_RUNPOD_PUBLIC_BASE_URL=

# Override avançado: permite host privado/local para RunPod.
# Deixe false, exceto quando o RunPod consegue alcançar sua rede privada.
IUDEX_ALLOW_PRIVATE_BASE_URL_FOR_RUNPOD=false

# =============================================================================
# TRANSCRIPTION / FORMATTING RESILIENCE
# =============================================================================
# Mantém fallback para RAW se a IA de formatação ficar indisponível.
IUDEX_ALLOW_LLM_FALLBACK_RAW=1

# Timeout de inicialização do motor de formatação.
IUDEX_VOMO_INIT_TIMEOUT_SECONDS=240

# Timeout adaptativo global:
# max(IUDEX_FORMAT_TIMEOUT_SECONDS, estimated_chunks * IUDEX_FORMAT_TIMEOUT_PER_CHUNK_SECONDS)
IUDEX_FORMAT_TIMEOUT_SECONDS=900
IUDEX_FORMAT_TIMEOUT_PER_CHUNK_SECONDS=120
IUDEX_FORMAT_TIMEOUT_CHARS_PER_CHUNK=15000
IUDEX_FORMAT_TIMEOUT_MAX_SECONDS=2700

# Timeout por segmento:
# - 0 = usa modo automático (recomendado)
# - >0 = força valor fixo por segmento
IUDEX_FORMAT_SEGMENT_TIMEOUT_SECONDS=0
IUDEX_FORMAT_SEGMENT_TIMEOUT_AUTO_SECONDS=120

# Retry de modelo em timeout/quota:
# se o modelo principal for preview (ex.: gemini-3-*-preview), tenta este estável.
IUDEX_FORMAT_RETRY_STABLE_MODEL=gemini-2.0-flash

# Processamento sequencial prioriza estabilidade/fidelidade.
IUDEX_PARALLEL_CHUNKS=1

# =============================================================================
# OPTIONAL SERVICES
# =============================================================================

# Sentry (Error Tracking)
# SENTRY_DSN=your-sentry-dsn

# Redis (Caching - Future)
# REDIS_URL=redis://localhost:6379/0

# =============================================================================
# LOGGING
# =============================================================================
LOG_LEVEL=INFO
# Options: DEBUG, INFO, WARNING, ERROR, CRITICAL

# =============================================================================
# RAG ADVANCED (defaults depend on ENVIRONMENT)
# =============================================================================
# Defaults:
# - production: enables multi-query, compression, parent-child, corrective.
# - development/local: by default ALSO enables them (to "destravar" o RAG local).
#   Set RAG_UNLOCK_ALL=false to restore the old behavior (dev defaults off).
#
# Master switch for local/dev:
# RAG_UNLOCK_ALL=true
# RAG_MULTI_QUERY_ENABLED=true
# RAG_MULTI_QUERY_MAX=3
# RAG_MULTI_QUERY_LLM=false
# RAG_CONTEXT_COMPRESSION_ENABLED=true
# RAG_CONTEXT_COMPRESSION_MAX_CHARS=900
# RAG_PARENT_CHILD_ENABLED=true
# RAG_PARENT_CHILD_WINDOW=1
# RAG_PARENT_CHILD_MAX_EXTRA=12
# RAG_CORRECTIVE_ENABLED=true
# RAG_CORRECTIVE_USE_HYDE=true
# RAG_CORRECTIVE_MIN_BEST_SCORE=0.5
# RAG_CORRECTIVE_MIN_AVG_SCORE=0.4

# Router (2 camadas): regras + LLM (opcional)
# RAG_ROUTER_LLM_ENABLED=false
# RAG_ROUTER_LLM_PROVIDERS=gemini
# RAG_ROUTER_LLM_MODEL=gemini-3-flash

# RAG Local (anexos/processo)
# RAG_LOCAL_RERANK_ENABLED=true

# =============================================================================
# RAG RERANKING (CrossEncoder)
# =============================================================================
# Improves precision but adds latency/CPU and may download a model on first run.
RAG_RERANK_ENABLED=true
RAG_RERANK_MAX_K=10
RAG_RERANK_MODEL=cross-encoder/ms-marco-MiniLM-L-6-v2

# =============================================================================
# NEO4J - GRAPH DATABASE (GraphRAG)
# =============================================================================
# Backend selection
RAG_GRAPH_BACKEND=neo4j

# Development default: Neo4j Enterprise local (Developer License)
# Use alternate host ports to coexist with Neo4j Desktop on 7474/7687.
NEO4J_URI=bolt://localhost:8687
NEO4J_USERNAME=neo4j
NEO4J_USER=neo4j
NEO4J_PASSWORD=change-me
NEO4J_DATABASE=iudex
NEO4J_HTTP_PORT=8474
NEO4J_BOLT_PORT=8687

# KG Builder routing (multi-domain)
# - Keep regex+GLiNER as baseline, trigger LLM only when confidence/coverage is low.
KG_BUILDER_LLM_AUTO_FALLBACK=false
KG_BUILDER_LLM_MIN_TOTAL_NODES=2
KG_BUILDER_LLM_MIN_GLINER_COVERAGE=0.15
KG_BUILDER_LLM_MIN_GLINER_CONFIDENCE=0.60
KG_BUILDER_GLINER_LOW_CONFIDENCE=0.55
# Optional domain labels for GLiNER (CSV or JSON list):
# KG_BUILDER_DOMAIN=legal  # presets: legal|general|finance|health
# GLINER_LABELS=person,organization,product,location,date,money
# GLINER_LABELS=["person","organization","product","location","date","money"]
#
# neo4j-graphrag KG Builder (Graph extraction)
# KG_BUILDER_GRAPHRAG_SEGMENT_SIZE=4000
# KG_BUILDER_GRAPHRAG_SEGMENT_OVERLAP=600  # default: ~15% do segment_size (legal)
# KG_BUILDER_GRAPHRAG_COST_PER_1M_INPUT_TOKENS_USD=  # optional (observability only)
#
# Embeddings provider for KG Builder (default: openai)
# KG_BUILDER_EMBEDDING_PROVIDER=openai  # openai|vertexai|none
# KG_BUILDER_EMBEDDING_MODEL=text-embedding-3-small

# Aura Enterprise (recommended for staging/production)
# NEO4J_URI=neo4j+s://<instance-id>.databases.neo4j.io
# NEO4J_USER=neo4j
# NEO4J_PASSWORD=<aura-password>
# NEO4J_DATABASE=neo4j
# AURA_INSTANCEID=<instance-id>
# AURA_INSTANCENAME=<instance-name>

# Hybrid mode (optional): keep :Entity but also apply labels per entity_type (Lei, Artigo, Sumula, ...)
# Safe by default: labels are applied only from a whitelist.
RAG_GRAPH_HYBRID_MODE=false
RAG_GRAPH_HYBRID_AUTO_SCHEMA=true
RAG_GRAPH_HYBRID_MIGRATE_ON_STARTUP=false

# Query settings
NEO4J_MAX_HOPS=2
NEO4J_MAX_CHUNKS=50

# Embedding training (optional, for advanced GraphRAG)
GRAPH_EMBEDDING_METHOD=rotate
GRAPH_EMBEDDING_DIM=128
GRAPH_EMBEDDING_EPOCHS=200
GRAPH_EMBEDDING_BATCH_SIZE=512
GRAPH_EMBEDDING_LR=0.001
GRAPH_EMBEDDING_NEG_SAMPLES=10
GRAPH_EMBEDDING_NEG_STRATEGY=self_adv
GRAPH_EMBEDDING_PATIENCE=20
GRAPH_EMBEDDING_CHECKPOINT_DIR=data/embeddings/checkpoints
GRAPH_EMBEDDING_RETRAIN_HOURS=24
GRAPH_EMBEDDING_MIN_NEW_TRIPLES=100

# =============================================================================
# Graph Writes (Safe, 2-phase) + Tool Approval Tokens (Cryptographically Binding)
# =============================================================================
# When enabled, `ask_graph` operation `link_entities` requires a preflight preview
# and then a second call with `confirm=true` + `token` to write.
LINK_ENTITIES_REQUIRE_CONFIRM=true
LINK_ENTITIES_PREFLIGHT_TTL_SECONDS=900
LINK_ENTITIES_TOKEN_SECRET=your-random-secret-here

# When enabled, tool approvals (SSE resume) require an approval_token emitted by
# the server to resume a paused tool call (prevents forged approvals).
TOOL_APPROVAL_REQUIRE_TOKEN=true
TOOL_APPROVAL_TTL_SECONDS=900
TOOL_APPROVAL_TOKEN_SECRET=your-random-secret-here

# =============================================================================
# Text2Cypher (Graph page /t2c)
# =============================================================================
# Enables natural-language -> Cypher (READ-only) with 3 security layers.
TEXT2CYPHER_ENABLED=true
TEXT2CYPHER_LLM_PROVIDER=openai  # openai|anthropic|vertexai|gemini (see GraphAskService)
TEXT2CYPHER_MODEL=gpt-4o-mini
